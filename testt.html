<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo-UA-map</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Open+Sans&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Balsamiq+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Pacifico&family=Roboto+Slab:wght@100..900&family=Sofia+Sans:ital,wght@1,1..1000&family=Ysabeau+SC:wght@1..1000&display=swap" rel="stylesheet">
    
   
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #map {
            
            height: 100%;
            width: 100%;
            /*font-family: 'Open Sans', sans-serif !important;*/
            font-family: "Balsamiq Sans", sans-serif;
            font-weight: 400;
            font-style: normal;
        }
        .export-import-tooltip{
            background-color: rgba(255, 255, 128, .5);
            
        }
        .imp-exp-block{
            display: flex;
            align-items: center;
            align-content: center;
            flex-direction: column;
            background-color: white; ;
            margin-top: 30%;
        }
        .leaflet-control{
            background: white;
            border: none !important;
            box-shadow: rgba(0, 0, 0, 0.16) 0px 3px 6px, rgba(0, 0, 0, 0.23) 0px 3px 6px !important;
        }
        .leaflet-control-layers-list{
            margin: 5px;
        }
        .leaflet-control-layers-list .leaflet-layerstree-header:hover{
            /*text-decoration: underline;*/
            background-color: rgb(240, 240, 240);
            cursor: pointer;
        }
        .leaflet-control-layers {
            transition: max-height 1s ease-out, opacity 0.3s ease-out;
            max-height: 20vh; 
            overflow: hidden;
            opacity: 1;
            }

            .leaflet-control-layers:hover {
            max-height: 100vh; 
            opacity: 1;
            }
        
        .custom-tooltip {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid black;
            padding: 5px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        .transperent{
            background-color: #0572a1;
        }
        .leaflet-tooltip.custom-tooltip1{
            margin-top: 1.5px;
            background-color: rgba(255, 255, 255, 0);
            box-shadow: none;
            border: none;
            font-size: 14px;
            font-weight: bold;
        }
        .leaflet-tooltip.custom-tooltip1:before {
            display: none !important; /* –í–∏–º–∏–∫–∞—î —Å—Ç—Ä—ñ–ª–æ—á–∫—É */
        }
        .leaflet-tooltip.custom-tooltip110{
            margin-top: 1.5px;
            background-color: rgba(255, 255, 255, 0);
            box-shadow: none;
            border: none;
            font-size: 14px;
            font-weight: bold;
        }
        .leaflet-tooltip.custom-tooltip110:before {
            display: none !important; /* –í–∏–º–∏–∫–∞—î —Å—Ç—Ä—ñ–ª–æ—á–∫—É */
        }
        .info-control {
            padding: 3.5px 3.5px 0px 3.5px;
            border-radius: 2px;
        }
        .info-control:hover {
            cursor: pointer;
        }
        .legend i {
            display: inline-block;
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid black;
        }

        .layer-measureboundary {
    stroke: red !important; /* –ß–µ—Ä–≤–æ–Ω–∏–π –∫–æ–ª—ñ—Ä */
    stroke-width: 4px !important; /* –¢–æ–≤—â–∏–Ω–∞ */
    opacity: 0.8 !important; /* –ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å */
}

/* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –∫—ñ–Ω—Ü–µ–≤–æ—ó –ª—ñ–Ω—ñ—ó (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è) */
.layer-measure-resultline {
    stroke: rgb(255, 0, 0) !important; /* –°–∏–Ω—ñ–π –∫–æ–ª—ñ—Ä */
    stroke-width: 4px !important; /* –¢–æ–≤—â–∏–Ω–∞ */
    opacity: 1 !important;
}

/* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –ø–ª–æ—â—ñ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è */
.layer-measure-resultarea {
    fill: rgba(192, 70, 77, 0.3) !important; /* –ü—Ä–æ–∑–æ—Ä–∏–π –∑–µ–ª–µ–Ω–∏–π */
    stroke: rgb(255, 0, 0) !important; /* –û–±–≤–µ–¥–µ–Ω–Ω—è –∑–µ–ª–µ–Ω–µ */
    stroke-width: 4px !important;
}

/* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è —Ç–æ—á–æ–∫ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è */
.layer-measurevertex {
    fill: rgb(255, 0, 0) !important;
    stroke: black !important;
    stroke-width: 4px;
    r: 6px; /* –†–∞–¥—ñ—É—Å —Ç–æ—á–∫–∏ */
}

.leaflet-pm-text {
    font-size: 20px;  /* –ó–∞–¥–∞–π—Ç–µ –±–∞–∂–∞–Ω–∏–π —Ä–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É */
    font-weight: bold; /* –ú–æ–∂–Ω–∞ —Ç–∞–∫–æ–∂ –∑–º—ñ–Ω–∏—Ç–∏ —Ç–æ–≤—â–∏–Ω—É —à—Ä–∏—Ñ—Ç—É */
    color: red; /* –ö–æ–ª—ñ—Ä —à—Ä–∏—Ñ—Ç—É */
}
.leaflet-bottom{
    position: absolute; 
    z-index:600 !important;
}

.leaflet-control-layers-list::-webkit-scrollbar {
    width: 8px; /* –¢–æ–≤—â–∏–Ω–∞ —Å–∫—Ä–æ–ª–±–∞—Ä—É */
}

/* –ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É —Å–∫—Ä–æ–ª–±–∞—Ä—É */
.leaflet-control-layers-list::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 10px;
}

/* –ö–æ–ª—ñ—Ä —Ç–∞ –≤–∏–≥–ª—è–¥ –ø–æ–≤–∑—É–Ω–∫–∞ */
.leaflet-control-layers-list::-webkit-scrollbar-thumb {
    background: #3a3a3a;
    border-radius: 10px;
}

/* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –∑–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä */
.leaflet-control-layers-list::-webkit-scrollbar-thumb:hover {
    background: #555;
}

input[type="checkbox"] {
  -webkit-appearance: none;
  appearance: none;
  background-color: transparent;
  margin: 0;

  font: inherit;
  color: currentColor;
  width: 1.15em;
  height: 1.15em;
  border: 0.15em solid currentColor;
  border-radius: 0.15em;
  transform: translateY(-0.075em);

  display: grid;
  place-content: center;
}
:root {
  --form-control-color: rgb(0, 0, 0);
  --form-control-disabled: #959495;
}
.leaflet-layerstree-header-label{
    display: inline-flex;
    align-items: center;
    gap: 0.5em; /* –í—ñ–¥—Å—Ç—É–ø –º—ñ–∂ —á–µ–∫–±–æ–∫—Å–æ–º —ñ —Ç–µ–∫—Å—Ç–æ–º */
    cursor: pointer;
}
.leaflet-layerstree-header-name b{
    font-size: 1.15em;
}
input[type="checkbox"] {
  appearance: none; /* –ü—Ä–∏–±–∏—Ä–∞—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —Å—Ç–∏–ª—å */
  display: inline-flex; /* –ó–∞–º—ñ—Å—Ç—å inline-block, —â–æ–± –ø—Ä–∞—Ü—é–≤–∞–≤ ::before */
  align-items: center; /* –í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è */
  justify-content: center;
  width: 1.15em;
  height: 1.15em;
  border: 0.15em solid currentColor;
  border-radius: 0.15em;
  vertical-align: middle; /* –í–∏—Ä—ñ–≤–Ω—é—î –∑ —Ç–µ–∫—Å—Ç–æ–º */
  margin-right: 0.5em; /* –í—ñ–¥—Å—Ç—É–ø –≤—ñ–¥ —Ç–µ–∫—Å—Ç—É */
  position: relative; /* –í–∞–∂–ª–∏–≤–æ –¥–ª—è ::before */
}

input[type="checkbox"]::before {
  content: "";
  width: 0.75em;  /* –ó–±—ñ–ª—å—à–µ–Ω–∏–π —Ä–æ–∑–º—ñ—Ä */
  height: 0.75em;
  clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
  transform: scale(0);
  transform-origin: bottom left;
  transition: 120ms transform ease-in-out;
  box-shadow: inset 1em 1em var(--form-control-color);
  background-color: CanvasText;
}

input[type="checkbox"]:checked::before {
  transform: scale(1);
}

input[type="checkbox"]:focus {
  outline: max(2px, 0.15em) solid currentColor;
  outline-offset: max(2px, 0.15em);
}

input[type="checkbox"]:disabled {
  --form-control-color: var(--form-control-disabled);
  color: var(--form-control-disabled);
  cursor: not-allowed;
}

input[type="radio"] {
  appearance: none;
  width: 1.15em;
  height: 1.15em;
  border: 0.15em solid currentColor;
  border-radius: 50%; /* –†–æ–±–∏—Ç—å –∫–Ω–æ–ø–∫—É –∫—Ä—É–≥–ª–æ—é */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-right: 0.5em;
  position: relative;
  vertical-align: middle;
}

input[type="radio"]::before {
  content: "";
  position: absolute;
  width: 0.65em;
  height: 0.65em;
  background-color: var(--form-control-color);
  border-radius: 50%;
  transform: scale(0);
  transition: 120ms transform ease-in-out;
}

input[type="radio"]:checked::before {
  transform: scale(1);
}

.wind-legend {
  opacity: 0; /* –ü–æ—á–∞—Ç–∫–æ–≤–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ */
  transform: translatex(-20px); /* –õ–µ–≥–∫–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏ –∑–Ω–∏–∑—É */
  transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
}

.wind-legend.show {
  opacity: 1;
  transform: translateY(0);
}

.donations-box {
            position: absolute;
            z-index: 9999; 
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: 	rgb(235, 224, 224, 0.65);
            width: 100%;
        } 
        .donations-block{
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Comic Sans MS, Comic Sans, cursive;
            padding-left: 2%;
            padding-right: 2%;
            width: 50%;
            height: 100%;
            max-height: 100%;
            background-color: rgba(140, 140, 140, 0.7);
            text-align: center;
            -webkit-box-shadow: 0px 0px 13px 5px rgba(0,0,0,0.75);
            -moz-box-shadow: 0px 0px 13px 5px rgba(0,0,0,0.75);
            box-shadow: 0px 0px 13px 5px rgba(0,0,0,0.75);
        }
        .donation-text{
            font-size: calc(0.8vw + 1vh);
            margin-top: 2%;
            
        }
        .donations-buttons{
            margin-top: 7%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-around;
            width: 100%;
            
        }
        .donations-buttons button {
            background-color: grey;
            border: 1px solid black;
            border-radius: 2%;
            padding: 1%;
            text-align: center;
            width: 40%;
            font-size: calc(0.8vw + 1vh);

            font-family: Comic Sans MS, Comic Sans, cursive;
            -webkit-box-shadow: 0px 0px 13px -2px rgba(0,0,0,0.75);
            -moz-box-shadow: 0px 0px 13px -2px rgba(0,0,0,0.75);
            box-shadow: 0px 0px 13px -2px rgba(0,0,0,0.75);
        }
        .donations-buttons button:hover{
            transform: scale(1.1, 1.1);
            cursor: pointer;
            
        }

        .display-none {
            display: none;
        }
        
    </style>
</head>
<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-auth.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyAQpI0dCWKbXACbnNi445Hro26SzrlsGdU",
            authDomain: "my-map-pj-54751.firebaseapp.com",
            projectId: "my-map-pj-54751",
            storageBucket: "my-map-pj-54751.firebasestorage.app",
            messagingSenderId: "349429907738",
            appId: "1:349429907738:web:8a6d42bfeaf8eb0b612ca3",
            measurementId: "G-T4XGCQ6PDH"
        };
    
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
    
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤—Ö–æ–¥—É
                window.location.href = "https://mark-000.github.io/pl-power-vis-map.github.io/login.html";
            } else {
                console.log("User is logged in:", user.email);
                // –¢—É—Ç –º–æ–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
            }
        });
    
        // –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–∫–∏ –≤–∏—Ö–æ–¥—É
    
    </script>

    <div class="donations-box" id="donation">
        <div class="donations-block">
            <div>
                <div style="font-size: calc(2.5vw + 1vh); font-weight: bold; margin-top: 20%;">–í—ñ—Ç–∞—î–º–æ –Ω–∞ PLS!</div>
                <div style="font-size: calc(1vw + 1vh); font-weight: bold;margin-top: 10px;">POLAND LAND SEARCH</div>
            </div>
            
            <form class="project-form" id="project-form">
              <div style="margin-top: 7%;">
                <div class="donation-text">–©–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑, –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–∫–∞–∑–∞—Ç–∏:</div>
                <div class="donation-text">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø—ñ–¥—Å—Ç–∞–Ω—Ü—ñ—ó, —á–∏ —Ü–µ–Ω—Ç—Ä—É –∑–æ–Ω–∏ –¥–æ –∞–Ω–∞–ª—ñ–∑—É</div>
                <input type="text" id="coords" placeholder="Enter coordinates" required>
                <div class="donation-text">–†–∞–¥—ñ—É—Å –∑–æ–Ω–∏ –¥–æ –∞–Ω–∞–ª—ñ–∑—É</div>
                <input type="number" id="radius" placeholder="Enter radius (km)" required>
                <div class="donation-text">–î–ª—è –ø—Ä–∏–∫–ª–∞–¥—É, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø—ñ–¥—Å—Ç–∞–Ω—Ü—ñ—ó "Che≈Çm" 400/220/110 kV - 51.15822, 23.44010 (—à–∏—Ä–æ—Ç–∞, –¥–æ–≤–≥–æ—Ç–∞) —É —Å–∏—Å—Ç–µ–º—ñ WGS 84, –∑–æ–Ω–∞ –∞–Ω–∞–ª—ñ–∑—É —Ä–∞–¥—ñ—É—Å–æ–º 20 –∫–º.</div>
              </div>
              <input type="submit" name="Start" value="Start">
            </form>

            <div id="analysis-status" style="display: none; margin-top: 20px;">
              <div style="font-weight: bold; font-size: 1.2em;">üîç –ê–Ω–∞–ª—ñ–∑ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è...</div>
              <ul id="status-log" style="margin-top: 10px;"></ul>
              <button onclick="hideDonationBox()" style="margin-top: 15px;">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
            
        </div>  
        
    
    </div>
    <button onclick="downloadAllGeoJSONLayers()" style="position: absolute; top: 10px; left: 50px; z-index: 999;">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ —à–∞—Ä–∏</button>


    <div id="map"></div>


    <link rel="stylesheet" href="https://mark-000.github.io/pl-power-vis-map.github.io/libs/leaflet.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.5.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://mark-000.github.io/pl-power-vis-map.github.io/libs/esri-leaflet.js"></script>
    
    <link rel="stylesheet" href="https://mark-000.github.io/pl-power-vis-map.github.io/libs/MarkerCluster.css" />
    <link rel="stylesheet" href="https://mark-000.github.io/pl-power-vis-map.github.io/libs/MarkerCluster.Default.css" />
<!--
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://jjimenezshaw.github.io/Leaflet.Control.Layers.Tree/L.Control.Layers.Tree.js"></script>
-->
    
    
    <!-- JavaScript –¥–ª—è MarkerCluster -->
    <script src="https://mark-000.github.io/pl-power-vis-map.github.io/libs/leaflet.markercluster.js"></script>

    <!--line-->
    <link rel="stylesheet" href="https://mark-000.github.io/pl-power-vis-map.github.io/libs/leaflet-measure.css" />
    <script src="https://mark-000.github.io/pl-power-vis-map.github.io/libs/leaflet-measure.js"></script>
    <!--tiffff-->
    <script src="https://cdn.jsdelivr.net/npm/georaster@1.6.0/dist/georaster.browser.bundle.min.js"></script>
    <script src="https://mark-000.github.io/pl-power-vis-map.github.io/libs/georaster-layer-for-leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/rainbowvis.js@1.1.1/rainbowvis.js"></script>
    <script src="https://mark-000.github.io/pl-power-vis-map.github.io/libs/geoblaze.web.min.js"></script>
    <!--derevo-->
    <link rel="stylesheet" href="L.Control.Layers.Tree.css">
    <script src="L.Control.Layers.Tree.js"></script>

    <!-- draw tool-------->
    <link rel="stylesheet" href="https://mark-000.github.io/pl-power-vis-map.github.io/libs/leaflet-geoman.css" />
    <script src="https://mark-000.github.io/pl-power-vis-map.github.io/libs/leaflet-geoman.min.js"></script>
    <!--poligon pattern-->
<!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å—Ç–∏–ª—é –ø–ª–∞–≥—ñ–Ω–∞ Leaflet.Pattern -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-pattern/0.0.6/leaflet.pattern.min.css" />

    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∞–º–æ–≥–æ –ø–ª–∞–≥—ñ–Ω–∞ Leaflet.Pattern -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-pattern/0.0.6/leaflet.pattern.min.js"></script>
     <!-- –≥–ª–æ–±—É—Å -->
    <script src="https://unpkg.com/leaflet-globes"></script>
    <!-- –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø–æ—à—É–∫ -->
    <link rel="stylesheet" href="https://mark-000.github.io/pl-power-vis-map.github.io/libs/Control.Geocoder.css" />
    <script src="https://mark-000.github.io/pl-power-vis-map.github.io/libs/Control.Geocoder.js"></script>


    <!-- –î–æ–¥–∞–≤–∞–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ proj4js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.2/proj4.js"></script>
    <script src="https://unpkg.com/proj4leaflet"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<!-- GML-->

<script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.6.5/ol.js"></script>
<script src="https://mark-000.github.io/pl-power-vis-map.github.io/libs/togeojson.js"></script>

<script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
<!-- –î–æ–¥–∞–π –≤ <head> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wellknown/1.0.1/wellknown.min.js"></script>









    <script>

        function clossebut(){
            const dispNone = document.getElementById("donation")
            dispNone.classList.add("display-none");
        }


  // –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ –≤—Å–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è
 




















// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏
let map = L.map('map', {
    zoomControl: false, // –•–æ–≤–∞—î–º–æ –∫–æ–Ω—Ç—Ä–æ–ª –∑—É–º—É, —â–æ–± –Ω–µ –∑–∞–≤–∞–∂–∞–≤ –∞–Ω—ñ–º–∞—Ü—ñ—ó
    attributionControl: false, // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∞—Ç—Ä–∏–±—É—Ü—ñ—é
    center: [20, 0], // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –≤–∏–≥–ª—è–¥ –Ω–∞ –≥–ª–æ–±—É—Å
    zoom: 1,
    globeView: true // –ê–∫—Ç–∏–≤—É—î–º–æ —Ä–µ–∂–∏–º –≥–ª–æ–±—É—Å–∞
});

var osmLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18
}).addTo(map);

// –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó - –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –≥–ª–æ–±—É—Å–∞
setTimeout(() => {
    map.flyTo([52.131907, 19.595214], 7, { // –ó–∞–¥–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ç–∞ –∑—É–º
        animate: true,
        duration: 3 // –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –∞–Ω—ñ–º–∞—Ü—ñ—ó
    });
});

// –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–ª–∏—Ç–æ–∫ –∫–∞—Ä—Ç–∏ (OpenStreetMap)
var WhiteLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png');

// –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–ª–∏—Ç–æ–∫ Google Maps
var googleLayer = L.tileLayer('http://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}', {
    attribution: 'Google Maps'
});
// Topo map
var topoLayer = L.tileLayer('https://tile.opentopomap.org/{z}/{x}/{y}.png', {
    attribution: 'opentopomap'
});

let globalCoords = "";
let globalRadius = 0;

// –û–±—Ä–æ–±–∫–∞ —Å–∞–±–º—ñ—Ç—É
document.getElementById("project-form").addEventListener("submit", function (e) {
    e.preventDefault();

    globalCoords = document.getElementById("coords").value.trim();
    globalRadius = parseFloat(document.getElementById("radius").value);

    if (globalCoords !== "" && !isNaN(globalRadius)) {
        // –•–æ–≤–∞—î–º–æ —Ñ–æ—Ä–º—É
        document.getElementById("project-form").style.display = "none";

        // –ü–æ–∫–∞–∑—É—î–º–æ –±–ª–æ–∫ –∞–Ω–∞–ª—ñ–∑—É
        document.getElementById("analysis-status").style.display = "block";
        fetchOrganicAddData();
        fetchDzialkiPolygonsFromGeoportal()
        // –î–æ–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å–∏
        addStatus("‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏: " + globalCoords);
        addStatus("‚úÖ –†–∞–¥—ñ—É—Å –∑–æ–Ω–∏: " + globalRadius + " –∫–º");
        setTimeout(() => {
            addStatus("üì° –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥–µ–æ–¥–∞–Ω–∏—Ö...");
            addPointAndCircleToMap(globalCoords, globalRadius);  // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏ —Ç–∞ –∫–æ–ª–∞
        }, 1000);

    } else {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ç–∞ —Ä–∞–¥—ñ—É—Å.");
    }
});

// –î–æ–¥–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –ª–æ–≥
function addStatus(message) {
    const li = document.createElement("li");
    li.textContent = message;
    document.getElementById("status-log").appendChild(li);
}

let pointLayer, circleLayer;

function addPointAndCircleToMap(coords, radius) {
    // –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ –º–∞—Å–∏–≤
    const coordsArray = coords.split(",").map(Number);
    const lat = coordsArray[0];
    const lon = coordsArray[1];

    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —à–∞—Ä—ñ–≤ –¥–ª—è —Ç–æ—á–∫–∏ —ñ –∫–æ–ª–∞
    pointLayer = L.layerGroup();  // –®–∞—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞
    circleLayer = L.layerGroup(); // –®–∞—Ä –¥–ª—è –∫–æ–ª–∞

    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞ (—Ç–æ—á–∫–∏) –Ω–∞ –æ–∫—Ä–µ–º–∏–π —à–∞—Ä
    L.circleMarker([lat, lon], {
        radius: 6, // –†–∞–¥—ñ—É—Å —Ç–æ—á–∫–∏
        fillColor: "black", // –ö–æ–ª—ñ—Ä –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
        color: "yellow", // –ö–æ–ª—ñ—Ä –æ–±–≤–µ–¥–µ–Ω–Ω—è
        weight: 1, // –¢–æ–≤—â–∏–Ω–∞ –æ–±–≤–µ–¥–µ–Ω–Ω—è
        opacity: 1, // –ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å –æ–±–≤–µ–¥–µ–Ω–Ω—è
        fillOpacity: 1 // –ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
    }).addTo(pointLayer);

    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–ª–∞ (—Ä–∞–¥—ñ—É—Å—É) –Ω–∞ –æ–∫—Ä–µ–º–∏–π —à–∞—Ä
    L.circle([lat, lon], {
        color: 'blue',
        fillColor: 'transparent',
        interactive: false,
        fillOpacity: 0.5,
        radius: radius * 1000  // –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–∞–¥—ñ—É—Å—É –≤ –º–µ—Ç—Ä–∏
    }).addTo(circleLayer);

    // –¶–µ–Ω—Ç—Ä—É—î–º–æ –∫–∞—Ä—Ç—É –Ω–∞ —Ç–æ—á—Ü—ñ
    map.setView([lat, lon], 13);
    
    // –î–æ–¥–∞—î–º–æ —Ü—ñ —à–∞—Ä–∏ –¥–æ –∫–æ–Ω—Ç—Ä–æ–ª—é
}

function updateLayerControl() {
    // –î–µ—Ä–µ–≤–æ —à–∞—Ä—ñ–≤ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é
    var overlaysTree = {
        label: "<b>–®–∞—Ä–∏</b>",
        selectAllCheckbox: true,  // –î–æ–¥–∞—î —á–µ–∫–±–æ–∫—Å –¥–ª—è –≤–∏–±–æ—Ä—É –≤—Å—ñ—Ö —à–∞—Ä—ñ–≤
        children: [
            { 
                label: "<b>–ï–ª–µ–∫—Ç—Ä–æ–º–µ—Ä–µ–∂—ñ</b>", 
                children: [
                    { label: "–¶–µ–Ω—Ç—Ä", layer: pointLayer },
                    { label: "–ó–æ–Ω–∞", layer: circleLayer },
                    { label: "Kowr", layer: dzialkiKowrLayerGroup },
                    { label: "–ì—Ä—É–Ω—Ç–∏ –æ—Ä–≥–∞–Ω—ñ—á–Ω—ñ ", layer: filteredLayerGroup },
                    { label: "–ì—Ä—É–Ω—Ç–∏ –ª—ñ—Å—É", layer: filteredLsLayerGroup },
                ]
            }
        ]
    };
    var baseTree = {
        label: "<b>–ë–∞–∑–æ–≤—ñ –∫–∞—Ä—Ç–∏</b>",
        children: [
            { label: "OpenStreetMap", layer: osmLayer, radioGroup: "basemap" },
            { label: "White Map", layer: WhiteLayer, radioGroup: "basemap" },
            { label: "Google Map", layer: googleLayer, radioGroup: "basemap" },
            { label: "Topo Map", layer: topoLayer, radioGroup: "basemap" },
        ]
    };
    // –î–æ–¥–∞—î–º–æ –∫–æ–Ω—Ç—Ä–æ–ª—å —à–∞—Ä—ñ–≤
    var layerControl = L.control.layers.tree(baseTree, overlaysTree, {
        namedToggle: false,  
        selectorBack: false, 
        closedSymbol: "‚ñ∂",  
        openedSymbol: "‚ñº",  
        collapsed: true
    }).addTo(map);

}

window.hideDonationBox = function () {
      updateLayerControl();
      document.getElementById("donation").style.display = "none";
    };




    let filteredLayerGroup = L.layerGroup().addTo(map);        // —Ç–æ—Ä—Ñ'—è–Ω—ñ
let filteredLsLayerGroup = L.layerGroup().addTo(map);  // <- –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –ì–õ–û–ë–ê–õ–¨–ù–û
    map.addLayer(filteredLayerGroup);
    map.addLayer(filteredLsLayerGroup);


function fetchOrganicAddData(){



// Define projections
proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
proj4.defs("EPSG:2180", "+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +units=m +no_defs");
let coordsArrayMain = globalCoords.split(",").map(Number);
// Center point and diagonal
const centerLat = Number(coordsArrayMain[0].toFixed(5)); // Center latitude
const centerLon = Number(coordsArrayMain[1].toFixed(5)); // Center longitude
const diagonalMeters = globalRadius * 1000*3; // 20 km in meters
console.log(centerLat)
console.log(centerLon)
// Function to calculate bounding box in EPSG:4326 from center and diagonal in meters
function getBoundingBoxFromCenterAndDiagonalLatLon(centerLat, centerLon, diagonalMeters) {
    const metersPerDegreeLat = 111320; // 1 degree latitude ‚âà 111.32 km
    const metersPerDegreeLon = 111320 * Math.cos(centerLat * Math.PI / 180); // Adjust for longitude

    // Assume a square box: width = height = diagonal / sqrt(2)
    const widthMeters = diagonalMeters / Math.sqrt(2);
    const heightMeters = widthMeters;

    // Convert meters to degrees
    const halfWidthDeg = (widthMeters / metersPerDegreeLon) / 2;
    const halfHeightDeg = (heightMeters / metersPerDegreeLat) / 2;

    return {
        bottomLeft: {
            lon: centerLon - halfWidthDeg,
            lat: centerLat - halfHeightDeg
        },
        topRight: {
            lon: centerLon + halfWidthDeg,
            lat: centerLat + halfHeightDeg
        }
    };
}

// Calculate bounding box in EPSG:4326
const { bottomLeft, topRight } = getBoundingBoxFromCenterAndDiagonalLatLon(centerLat, centerLon, diagonalMeters);

// Transform coordinates to EPSG:2180
const [x1, y1] = proj4("EPSG:4326", "EPSG:2180", [bottomLeft.lon, bottomLeft.lat]);
const [x2, y2] = proj4("EPSG:4326", "EPSG:2180", [topRight.lon, topRight.lat]);

// URL and params for the API query
const url = "https://mapy.geoportal.gov.pl/gprest/services/MapaGlebowoRolnicza/MapServer/2/query";
const params = {
    geometry: `${x1},${y1},${x2},${y2}`, // Bounding box in EPSG:2180
    geometryType: "esriGeometryEnvelope",
    spatialRel: "esriSpatialRelIntersects",
    outFields: "*",
    outSR: "4326", // Output in EPSG:4326
    returnGeometry: "true",
    f: "geojson",
    resultRecordCount: 2000,
    resultOffset: 0
};

// Function to fetch all features
async function getAllFeatures() {
    let allFeatures = [];
    let offset = 0;

    while (true) {
        params.resultOffset = offset;
        const queryUrl = `${url}?${new URLSearchParams(params)}`;
        console.log("–ó–∞–ø–∏—Ç: ", queryUrl);
        const apiUrlElement = document.getElementById("api-url");
        if (apiUrlElement) apiUrlElement.textContent = queryUrl;

        const response = await fetch(queryUrl);
        const data = await response.json();

        if (data && data.features) {
            const features = data.features;
            allFeatures = allFeatures.concat(features);
            if (features.length < 2000) break;
            offset += 2000;
        } else {
            console.log("‚ùå –ü–æ–º–∏–ª–∫–∞", data);
            break;
        }
    }
    return allFeatures;
}

// Filter features
function filterFeatures(features) {
    const torfyFeatures = [];
    const lsFeatures = [];

    features.forEach(feature => {
        const props = feature.properties;

        const uwagi = props.UWAGI || "";
        const typpodtyp = props.TYPPODTYP || "";
        const typpodtypNr = props.TYPPODTYP_NR || "";
        const kompleks = props.KOMPLEKS || "";
        const kompleksNr = props.KOMPLEKS_NR || "";

        const rodzajFields = [
            props.RODZAJGLEBYORGANICZNEJ1,
            props.RODZAJGLEBYORGANICZNEJ2,
            props.RODZAJGLEBYORGANICZNEJ3,
            props.RODZAJGLEBYORGANICZNEJ4,
            props.RODZAJGLEBYORGANICZNEJ5
        ];

        const isTorfowy =
            uwagi.includes("torfy") ||
            uwagi.includes("Tn") ||
            typpodtyp === "T" ||
            typpodtypNr === "T" ||
            typpodtyp === "Emt" ||
            typpodtypNr === "Emt" ||
            typpodtyp === "Etm" ||
            typpodtypNr === "Etm" ||
            typpodtyp === "E" ||
            typpodtypNr === "E" ||
            rodzajFields.some(field => field && field.trim() !== "");

        const isLs =
            kompleks === "Ls" ||
            kompleksNr === "Ls";

        if (isTorfowy) torfyFeatures.push(feature);
        if (isLs) lsFeatures.push(feature);
    });

    return { torfyFeatures, lsFeatures };
}

// Add filtered polygons to map
function addFilteredPolygonsToMap(features, layerGroup, color) {
    layerGroup.clearLayers();
    features.forEach(feature => {
        L.geoJSON(feature.geometry, {
            style: {
                color: color,
                weight: 2,
                opacity: 0.6,
                fillColor: color,
                fillOpacity: 0.3
            }
        }).addTo(layerGroup);
    });
}


// Fetch and add data
async function fetchAndAddData() {
    const features = await getAllFeatures();
    const { torfyFeatures, lsFeatures } = filterFeatures(features);

    if (torfyFeatures.length > 0) {
        addFilteredPolygonsToMap(torfyFeatures, filteredLayerGroup, "blue");
    }

    if (lsFeatures.length > 0) {
        addFilteredPolygonsToMap(lsFeatures, filteredLsLayerGroup, "green");
    }

    if (torfyFeatures.length === 0 && lsFeatures.length === 0) {
        console.log("‚ùå –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è");
    }
}
fetchAndAddData();
// Execute the fetch
// –í–∏–∫–ª–∏–∫–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –Ω–∞ –∫–∞—Ä—Ç—É fetchAndAddData();
}







// Define projections
proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
proj4.defs("EPSG:2180", "+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +units=m +no_defs");

let dzialkiKowrLayerGroup = L.layerGroup().addTo(map);

function fetchDzialkiPolygonsFromGeoportal() {
    dzialkiKowrLayerGroup.clearLayers();

    let coordsArrayMain = globalCoords.split(",").map(Number);
    const centerLat = Number(coordsArrayMain[0].toFixed(5));
    const centerLon = Number(coordsArrayMain[1].toFixed(5));
    const diagonalMeters = globalRadius * 1000 * 3;

    const metersPerDegreeLat = 111320;
    const metersPerDegreeLon = 111320 * Math.cos(centerLat * Math.PI / 180);
    const widthMeters = diagonalMeters / Math.sqrt(2);
    const halfWidthDeg = (widthMeters / metersPerDegreeLon) / 2;
    const halfHeightDeg = (widthMeters / metersPerDegreeLat) / 2;

    const bottomLeft = { lon: centerLon - halfWidthDeg, lat: centerLat - halfHeightDeg };
    const topRight = { lon: centerLon + halfWidthDeg, lat: centerLat + halfHeightDeg };

    const [x1, y1] = proj4("EPSG:4326", "EPSG:2180", [bottomLeft.lon, bottomLeft.lat]);
    const [x2, y2] = proj4("EPSG:4326", "EPSG:2180", [topRight.lon, topRight.lat]);
    const bboxParam = `${x1},${y1},${x2},${y2}`;

    const wfsUrl = `https://mapy.geoportal.gov.pl/wss/ext/kowr?service=WFS&version=1.1.0&request=GetFeature&typeName=ms:dzialki&srsName=EPSG:2180&bbox=${bboxParam}&outputFormat=text/xml;%20subtype=gml/3.1.1`;
    console.log(wfsUrl)
    
    fetch(wfsUrl)
    .then(response => response.text())
    .then(gmlText => {
        // –ü–∞—Ä—Å–∏–Ω–≥ GML
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(gmlText, "application/xml");

        // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –≥–µ–æ–º–µ—Ç—Ä—ñ—ó
        const features = xmlDoc.getElementsByTagName("gml:featureMember");
        
        
// –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        proj4.defs('EPSG:2180', '+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +units=m +no_defs');
        proj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs');

        const geojson = {
            type: "FeatureCollection",
            features: []
        };

for (let i = 0; i < features.length; i++) {
    const feature = features[i];
    const polygon = feature.getElementsByTagName("ms:msGeometry")[0];
    const posList = polygon.getElementsByTagName("gml:posList")[0].textContent.trim();

    // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
    const coords = posList.split(" ").map(coord => parseFloat(coord));
    let swappedCoords = [];

    // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∑ EPSG:2180 –¥–æ EPSG:4326
    for (let j = 0; j < coords.length; j += 2) {
        const x = coords[j + 1]; // –°—Ö—ñ–¥ (Easting)
        const y = coords[j];     // –ü—ñ–≤–Ω—ñ—á (Northing)
        const [lon, lat] = proj4('EPSG:2180', 'EPSG:4326', [x, y]); // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è
        swappedCoords.push([lon, lat]); // –î–æ–¥–∞—î–º–æ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É: [–¥–æ–≤–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞]
    }

    // –î–æ–¥–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —è–∫ –ª—ñ–Ω—ñ—é –≤ –ø–æ–ª—ñ–≥–æ–Ω—ñ (GeoJSON)
    geojson.features.push({
        type: "Feature",
        geometry: {
            type: "Polygon",
            coordinates: [swappedCoords] // –ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–ª–∞—Å—Ç–∏ –≤ –º–∞—Å–∏–≤ –¥–ª—è Polygon
        },
        properties: {}
    });
}
    const kowrL = L.geoJSON(geojson, {
            style: function () {
                return {
                    color: "#ff7800",    // –ö–æ–ª—ñ—Ä –º–µ–∂—ñ
                    weight: 2,           // –¢–æ–≤—â–∏–Ω–∞ –º–µ–∂—ñ
                    opacity: 0.65,       // –ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å –º–µ–∂—ñ
                    fillOpacity: 0.3     // –ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
                };
            }
        })
        dzialkiKowrLayerGroup.addLayer(kowrL);

// –í–∏–≤–æ–¥–∏–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    console.log(JSON.stringify(geojson, null, 2));
    })
    .catch(error => {
        console.error("‚ùå Error fetching or parsing GML:", error);
    });

}




const geoJsonLayerGroupDilyanka = L.layerGroup().addTo(map);
let geoJsonLayerGroupDilAdded = L.layerGroup().addTo(map);

const crs2180 = new L.Proj.CRS(
  "EPSG:2180",
  "+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs",
  {
    resolutions: [8192, 4096, 2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2, 1, 0.5],
    origin: [0, 0],
  }
);

map.on("click", function (e) {
    let alreadyExists = false;

  /*geoJsonLayerGroupDilyanka.eachLayer(function(layer) {
    if (layer.getBounds && layer.getBounds().contains(e.latlng)) {
      alreadyExists = true;
    }
  });

  // –Ø–∫—â–æ –≤ –º—ñ—Å—Ü—ñ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è —î —à–∞—Ä, –Ω–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –ø–æ–¥–∞–ª—å—à—ñ –¥—ñ—ó
  if (alreadyExists) {
    console.log("–®–∞—Ä –≤–∂–µ —î –≤ —Ü—å–æ–º—É –º—ñ—Å—Ü—ñ, –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ.");
    return; // –í–∏—Ö–æ–¥–∏–º–æ –∑ —Ñ—É–Ω–∫—Ü—ñ—ó, –Ω–µ –¥–æ–¥–∞—é—á–∏ –Ω–æ–≤–∏–π –ø–æ–ª—ñ–≥–æ–Ω
  }*/
  geoJsonLayerGroupDilyanka.clearLayers();

  const point2180 = proj4("EPSG:4326", "EPSG:2180", [e.latlng.lng, e.latlng.lat]);

  const x = point2180[0];
  const y = point2180[1];

  // –°–≤–∞–ø –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è–º BBOX (–º—ñ–Ω—è—î–º–æ –º—ñ—Å—Ü—è–º–∏ X —ñ Y)
  const delta = 1.0; // —Ä–æ–∑–º—ñ—Ä –ø–æ–ª–æ–≤–∏–Ω–∏ bbox —É –º–µ—Ç—Ä–∞—Ö
  const bbox = [
    y - delta,  // —Å–ø–æ—á–∞—Ç–∫—É Y (–ø—ñ–≤–¥–µ–Ω–Ω–∏–π –∑–∞—Ö—ñ–¥)
    x - delta,  // –ø–æ—Ç—ñ–º X (–ø—ñ–≤–¥–µ–Ω–Ω–∏–π –∑–∞—Ö—ñ–¥)
    y + delta,  // –ø–æ—Ç—ñ–º Y (–ø—ñ–≤–Ω—ñ—á–Ω–∏–π —Å—Ö—ñ–¥)
    x + delta,  // –ø–æ—Ç—ñ–º X (–ø—ñ–≤–Ω—ñ—á–Ω–∏–π —Å—Ö—ñ–¥)
  ].join(",");

  const baseUrl =
    "https://mapy.geoportal.gov.pl/imapnext/api/prx/xsvc/?" +
    "https://integracja.gugik.gov.pl/cgi-bin/KrajowaIntegracjaEwidencjiGruntow";

  const params = {
    language: "pol",
    SERVICE: "WMS",
    REQUEST: "GetFeatureInfo",
    VERSION: "1.3.0",
    LAYERS: "numery_dzialek,dzialki,geoportal,budynki,kontury,uzytki",
    QUERY_LAYERS: "numery_dzialek,dzialki,geoportal,budynki,kontury,uzytki",
    CRS: "EPSG:2180",
    BBOX: bbox,
    INFO_FORMAT: "text/xml",
    FORMAT: "image/png",
    WIDTH: 101,
    HEIGHT: 101,
    I: 50,
    J: 50,
  };

  const url =
    baseUrl + "?" +
    Object.entries(params)
      .map(([key, val]) => `${key}=${encodeURIComponent(val)}`)
      .join("&");

  fetch(url)
    
    .then((res) => res.text())
    .then((xmlText) => {
        console.log("kadastr url", url)
      // –¢—É—Ç —Ç–∏ –º–æ–∂–µ—à –ø–∞—Ä—Å–∏—Ç–∏ XML —ñ –≤–∏—Ç—è–≥–∞—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–∞–Ω—ñ
      const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, "text/xml");

    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ <gml:featureMember>
    const featureMembers = xmlDoc.getElementsByTagName("gml:featureMember");

    // –ú–∞—Å–∏–≤ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
    const jsonData = [];

    // –ü–µ—Ä–µ–±–∏—Ä–∞—î–º–æ –≤—Å—ñ <gml:featureMember>
    Array.from(featureMembers).forEach((feature) => {
      // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç –¥–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Å—É
      const attributes = {};

      // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ <Attribute> –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ feature
      const attributeElements = feature.getElementsByTagName("Attribute");

      Array.from(attributeElements).forEach((attr) => {
        const name = attr.getAttribute("Name");
        const value = attr.textContent.trim();

        // –î–æ–¥–∞—î–º–æ –∞—Ç—Ä–∏–±—É—Ç–∏ –≤ –æ–±'—î–∫—Ç
        attributes[name] = value;
      });

      // –î–æ–¥–∞—î–º–æ –æ–±'—î–∫—Ç –≤ –º–∞—Å–∏–≤
      jsonData.push(attributes);
    });

    // –í–∏–≤–æ–¥–∏–º–æ –æ—Ç—Ä–∏–º–∞–Ω–∏–π JSON
    jsonData.forEach((item) => {
      const parcelId = item["Identyfikator dzia≈Çki"];

      // –§–æ—Ä–º—É—î–º–æ URL –¥–ª—è –∑–∞–ø–∏—Ç—É –∑–∞ –≥–µ–æ–º–µ—Ç—Ä—ñ—î—é
      const url2 = `https://uldk.gugik.gov.pl/?request=GetParcelById&id=${parcelId}&result=geom_wkt&srid=4326`;
      console.log(url2);

      fetch(url2)
        .then(response => response.text())
        .then(data => {
          // –†–æ–∑–¥—ñ–ª—è—î–º–æ –¥–∞–Ω—ñ, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ WKT (–ø–æ–ª—ñ–≥–æ–Ω)
          const wktGeometry = data.split("\n")[1]; // –ë–µ—Ä–µ–º–æ –¥—Ä—É–≥—É —Å—Ç—Ä–æ–∫—É

          // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ WKT –≤ –º–∞—Å–∏–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
          const coordinates = wktGeometry
            .match(/\(([^()]+)\)/)[1] // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –º—ñ–∂ –¥—É–∂–∫–∞–º–∏
            .split(",") // –†–æ–∑–¥—ñ–ª—è—î–º–æ –ø–∞—Ä–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            .map(coord => coord.trim().split(" ").map(Number)); // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ —É —á–∏—Å–ª–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç

          // –°—Ç–≤–æ—Ä—é—î–º–æ GeoJSON –∑ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º –∞—Ç—Ä–∏–±—É—Ç—ñ–≤
          const geoJson = {
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [coordinates]
            },
            properties: {
              ...item // –î–æ–¥–∞—î–º–æ –∞—Ç—Ä–∏–±—É—Ç–∏ –∑ XML –¥–æ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π GeoJSON
            }
          };
          const geoDilyanka = L.geoJSON(geoJson, {
  onEachFeature: function(feature, layer) {
    layer.bindPopup(`
      <b>–î—ñ–ª—è–Ω–∫–∞:</b> ${feature.properties["Identyfikator dzia≈Çki"] || 'Unknown'}<br>
      <button id="addToGroupButton">+ –î–æ–¥–∞—Ç–∏ –¥–æ –∫–∞—Ä—Ç–∏</button>
      <button id="removeFromGroupButton">- –í–∏–¥–∞–ª–∏—Ç–∏ –∑ –∫–∞—Ä—Ç–∏</button>
    `);

    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –ø–æ–ø–∞–ø—É
    layer.on('popupopen', function() {
      const popupElement = layer.getPopup().getElement();

      // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–æ–¥–∞—Ç–∏"
      const addButton = popupElement.querySelector('#addToGroupButton');
      if (addButton) {
        addButton.replaceWith(addButton.cloneNode(true)); // –û—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
        const newAddButton = popupElement.querySelector('#addToGroupButton');
        newAddButton.addEventListener('click', function() {
          // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä —à–∞—Ä—É –¥–ª—è geoJsonLayerGroupDilAdded
          const geoDilyankaCopy = L.geoJSON(geoJson, {
            style: {
              color: "purple",
              weight: 2,
              opacity: 0.65,
              fillOpacity: 0.3
            },
            onEachFeature: function(feature, layer) {
              // –ü—Ä–∏–≤‚Äô—è–∑—É—î–º–æ –ø–æ–ø–∞–ø –¥–æ –Ω–æ–≤–æ–≥–æ —à–∞—Ä—É
              layer.bindPopup(`
                <b>–î—ñ–ª—è–Ω–∫–∞:</b> ${feature.properties["Identyfikator dzia≈Çki"] || 'Unknown'}
                <button id="removeFromAddedGroupButton">- –í–∏–¥–∞–ª–∏—Ç–∏ –∑ –∫–∞—Ä—Ç–∏</button>
              `);

              layer.on('popupopen', function() {
                const popupElementCopy = layer.getPopup().getElement();
                const removeButton = popupElementCopy.querySelector('#removeFromAddedGroupButton');
                if (removeButton) {
                  removeButton.replaceWith(removeButton.cloneNode(true));
                  const newRemoveButton = popupElementCopy.querySelector('#removeFromAddedGroupButton');
                  newRemoveButton.addEventListener('click', function() {
                    if (geoJsonLayerGroupDilAdded.hasLayer(geoDilyankaCopy)) {
                      geoJsonLayerGroupDilAdded.removeLayer(geoDilyankaCopy);
                      geoJsonLayerGroupDilyanka.removeLayer(geoDilyanka);
                      console.log("–í–∏–¥–∞–ª–µ–Ω–æ –∑ geoJsonLayerGroupDilAdded");
                    }
                    layer.closePopup();
                  });
                }
              });
            }
          });
          geoJsonLayerGroupDilAdded.addLayer(geoDilyankaCopy);
          geoJsonLayerGroupDilyanka.removeLayer(geoDilyanka);
          map.fitBounds(geoDilyankaCopy.getBounds());
          layer.closePopup(); // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –ø–æ–ø–∞–ø –ø—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è
        });
      }

      // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í–∏–¥–∞–ª–∏—Ç–∏"
      const removeButton = popupElement.querySelector('#removeFromGroupButton');
      if (removeButton) {
        removeButton.replaceWith(removeButton.cloneNode(true)); // –û—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
        const newRemoveButton = popupElement.querySelector('#removeFromGroupButton');
        newRemoveButton.addEventListener('click', function() {
          if (geoJsonLayerGroupDilyanka.hasLayer(geoDilyanka)) {
            geoJsonLayerGroupDilyanka.removeLayer(geoDilyanka);
            console.log("–í–∏–¥–∞–ª–µ–Ω–æ –∑ geoJsonLayerGroupDilyanka");
          }
          layer.closePopup();
        });
      }
    });
  },
  style: function() {
    return {
      color: "black",
      weight: 2,
      opacity: 0.65,
      fillOpacity: 0.3
    };
  }
});

// –î–æ–¥–∞—î–º–æ –ø–æ–ª—ñ–≥–æ–Ω –¥–æ –æ—Å–Ω–æ–≤–Ω–æ—ó –≥—Ä—É–ø–∏
geoJsonLayerGroupDilyanka.addLayer(geoDilyanka);
geoDilyanka.eachLayer(function(layer) {
  layer.openPopup();
});

// –í–∏–≤–æ–¥–∏–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
console.log(JSON.stringify(geoJson, null, 2));

});

    
});
});
});




//https://integracja01.gugik.gov.pl/cgi-bin/KrajowaIntegracjaEwidencjiGruntow?VERSION=1.1.1&SERVICE=WMS&REQUEST=GetMap&LAYERS=dzialki,numery_dzialek,budynki&SRS=EPSG:2180&WIDTH=1570&HEIGHT=916&TRANSPARENT=TRUE&FORMAT=image/png&BBOX=659944.766407799,486467.44840687,660557.657032805,486824.870281908




const kadasrwms = L.tileLayer.wms("https://integracja01.gugik.gov.pl/cgi-bin/KrajowaIntegracjaEwidencjiGruntow", {
  layers: "dzialki,kontury,numery_dzialek",
  format: "image/png",
  transparent: true,
  version: "1.1.1",
  attribution: "¬© GUGiK"
});

kadasrwms.addTo(map);

/*const konturyWms = L.tileLayer.wms("https://wms16.epodgik.pl/cgi-bin/int_kuzg", {
  layers: "kontury_klasyfikacyjne",
  format: "image/png",
  transparent: true,
  version: "1.1.1",
  attribution: "¬© GUGiK"
});

konturyWms.addTo(map);*/




















function downloadAllGeoJSONLayers() {
    const zip = new JSZip();

    function addLayerToZip(layerGroup, fileName) {
        const geojson = {
            type: "FeatureCollection",
            features: []
        };

        layerGroup.eachLayer(layer => {
            if (layer.toGeoJSON) {
                const layerGeoJSON = layer.toGeoJSON();
                if (Array.isArray(layerGeoJSON.features)) {
                    geojson.features.push(...layerGeoJSON.features);
                } else {
                    geojson.features.push(layerGeoJSON);
                }
            }
        });

        if (geojson.features.length > 0) {
            const geojsonStr = JSON.stringify(geojson, null, 2);
            zip.file(fileName, geojsonStr);
        }
    }

    // –î–æ–¥–∞—Ç–∏ –≤—Å—ñ —à–∞—Ä–∏ –¥–æ ZIP
    addLayerToZip(pointLayer, "point.geojson");
    //addLayerToZip(circleLayer, "circle.geojson");
    addLayerToZip(filteredLayerGroup, "torfy.geojson");          // —Ç–æ—Ä—Ñ'—è–Ω—ñ
    addLayerToZip(filteredLsLayerGroup, "ls.geojson");     
    addLayerToZip(dzialkiKowrLayerGroup, "kowr.geojson");    
    addLayerToZip(geoJsonLayerGroupDilAdded, "selectedDil.geojson");       // Ls –∫–æ–º–ø–ª–µ–∫—Å

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ZIP
    zip.generateAsync({ type: "blob" }).then(content => {
        saveAs(content, "map_layers.zip");
    });
}








































    // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è OpenStreetMap
      //  osmLayer.addTo(map);
      var coordDiv = L.control({ position: 'bottomright' });

coordDiv.onAdd = function () {
    var div = L.DomUtil.create('div', 'coordinate-display');
    div.style.padding = '5px';
    div.style.background = 'white';
    div.style.opacity = '0.8';
    div.style.cursor = 'pointer'; // –î–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—å –¥–ª—è –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–∞ –º–∏—à—ñ
    div.innerHTML = "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:";
    
    // –î–æ–¥–∞—î–º–æ –ø–æ–¥—ñ—é –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –ø—Ä–∏ –∫–ª—ñ–∫—É
    div.addEventListener('click', function () {
        const text = div.innerText.replace('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:', '').trim();
        navigator.clipboard.writeText(text).then(() => {
            div.innerHTML = `‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ ${text}`;
            setTimeout(updateCenterCoordinates, 1500); // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–∞–∑–∞–¥ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥–∏
        }).catch(err => console.error("–ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è:", err));
    });

    return div;
};

coordDiv.addTo(map);

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ü–µ–Ω—Ç—Ä—É –∫–∞—Ä—Ç–∏
function updateCenterCoordinates() {
    var center = map.getCenter();
    document.querySelector('.coordinate-display').innerHTML = 
        `${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}`;
}

// –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø—Ä–∏ —Ä—É—Å—ñ –∫–∞—Ä—Ç–∏
map.on('moveend', updateCenterCoordinates);

// –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
updateCenterCoordinates();

       L.Control.Info = L.Control.extend({
            onAdd: function(map) {
                var container = L.DomUtil.create("div", "info-control");
                container.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="black"><path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>';
                container.title = "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó";
                
                container.onclick = function() {
                    alert("üìå –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –ø—Ä–∞–≤–æ—é –∫–Ω–æ–ø–∫–æ—é –º–∏—à—ñ –Ω–∞ –∫–∞—Ä—Ç—É.\nüìå –ü—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —Ç–∞–π–ª –∑ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏.\nüìå –î–ª—è –æ—á–∏—â–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –∫–æ–ª–µ—Å–∏–∫–æ –º–∏—à—ñ.");
                };
        
                return container;
            }
        });

        // –î–æ–¥–∞—î–º–æ –µ–ª–µ–º–µ–Ω—Ç –Ω–∞ –∫–∞—Ä—Ç—É
        var infoControl = new L.Control.Info({ position: "topleft" });
        map.addControl(infoControl);
//-----------------------------–º–∞–ª—é–≤–∞–Ω–Ω—è - –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è--------------------------------------
        var measureControl = new L.Control.Measure({
            position: "topleft",
            primaryLengthUnit: "meters",
            secondaryLengthUnit: "kilometers", // –û–¥–∏–Ω–∏—Ü—ñ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è
            primaryAreaUnit: "hectares",
            secondaryAreaUnit: "sqmeters",
            showMeasurements: true, // –ü–æ–∫–∞–∑—É—î –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –ª—ñ–Ω—ñ–π
            captureZIndex: 10000,
            measureControlTitle: "–í–∏–º—ñ—Ä—è—Ç–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å",
            activeColor: '#ff0000',  // –ö–æ–ª—ñ—Ä –ª—ñ–Ω—ñ—ó –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è
            completedColor: '#0000ff'
            
        });

        map.addControl(measureControl);

        
        // –î–æ–¥–∞—î–º–æ –µ–ª–µ–º–µ–Ω—Ç –Ω–∞ –∫–∞—Ä—Ç—É
        map.pm.addControls({
            position: 'bottomright', // –†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –ø–∞–Ω–µ–ª—ñ
            drawCircle: true,
            drawRectangle: false,
            drawPolygon: true, 
            drawMarker: false, // –í–∏–º–∫–Ω—É—Ç–∏ —Ç–æ—á–∫–∏
            drawCircleMarker: false, // –í–∏–º–∫–Ω—É—Ç–∏ –∫—Ä—É–≥–ª—ñ –º–∞—Ä–∫–µ—Ä–∏
            drawText: true, // –í–∏–º–∫–Ω—É—Ç–∏ —Ç–µ–∫—Å—Ç
            measureControl: true,
            editMode: false, // –í–∏–º–∏–∫–∞—î —Ä–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
            cutPolygon: false,
            rotateMode: false,
        });

        // 4. –í–∫–ª—é—á–∞—î–º–æ —Ä–µ–∂–∏–º –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –¥–æ–≤–∂–∏–Ω–∏/–ø–ª–æ—â—ñ
        map.pm.setGlobalOptions({
            measureControl: true,  // –î–æ–¥–∞—î –∫–Ω–æ–ø–∫—É –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è
            allowSelfIntersection: true, // –í–∏–º–∏–∫–∞—î –ø–µ—Ä–µ—Ç–∏–Ω —Å–∞–º–∏—Ö —Å–µ–±–µ
            cutPolygon: false, // –í–∏–º–∏–∫–∞—î –≤–∏—Ä—ñ–∑–∞–Ω–Ω—è –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤
            editMode: false,
            rotateMode: false,
            snappable: false,
        });

        map.pm.setPathOptions({
            color: 'red',        // –ö–æ–ª—ñ—Ä –ª—ñ–Ω—ñ–π
            fillColor: 'red',   // –ö–æ–ª—ñ—Ä –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤
            fillOpacity: 0,    // –ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤
            weight: 2           // –¢–æ–≤—â–∏–Ω–∞ –ª—ñ–Ω—ñ–π
        });

        let distanceTooltip;
    
        map.on('pm:drawstart', function (e) {
            if (e.workingLayer instanceof L.Polyline) {
                let totalDistance = 0;
                let lastLatLng = null;

                e.workingLayer.on('pm:vertexadded', function (event) {
                    let latlngs = e.workingLayer.getLatLngs();
                    let currentLatLng = latlngs[latlngs.length - 1]; 

                    if (lastLatLng !== null) {
                        totalDistance += lastLatLng.distanceTo(currentLatLng);
                    }
                    lastLatLng = currentLatLng;

                    if (distanceTooltip) {
                        map.removeLayer(distanceTooltip);
                    }

                    distanceTooltip = L.tooltip({
                        permanent: false,
                        direction: 'top',
                        className: 'distance-tooltip'
                    })
                        .setLatLng(currentLatLng)
                        .setContent(`${totalDistance.toFixed(2)} –º`)
                        .addTo(map);
                });

                map.once('pm:drawend', function () {
                    if (distanceTooltip) {
                        map.removeLayer(distanceTooltip);
                    }
                });
            }
        });




map.on('pm:drawstart', function (e) {
    if (e.workingLayer instanceof L.Circle) {
        let centerLatLng = null;

        // –°–ª—É—Ö–∞—á –ø–æ–¥—ñ—ó –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ü–µ–Ω—Ç—Ä—É –∫–æ–ª–∞
        map.on('click', function setCenter(event) {
            centerLatLng = event.latlng; // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ü–µ–Ω—Ç—Ä –∫–æ–ª–∞ –Ω–∞ –ø–µ—Ä—à–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ –∫–∞—Ä—Ç—É
            map.off('click', setCenter); // –í–∏–º–∏–∫–∞—î–º–æ —Å–ª—É—Ö–∞—á–∞ –ø—ñ—Å–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ü–µ–Ω—Ç—Ä—É

            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç—É–ª—Ç—ñ–ø –ø—ñ–¥ —á–∞—Å –º–∞–ª—é–≤–∞–Ω–Ω—è
            let moveListener = function (event) {
                let currentLatLng = event.latlng;
                let radius = centerLatLng.distanceTo(currentLatLng); // –í—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É –∫–æ–ª–∞ –¥–æ –ø–æ—Ç–æ—á–Ω–æ—ó —Ç–æ—á–∫–∏

                // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π —Ç—É–ª—Ç—ñ–ø
                if (distanceTooltip) {
                    map.removeLayer(distanceTooltip);
                }

                // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π —Ç—É–ª—Ç—ñ–ø –±—ñ–ª—è –∫—É—Ä—Å–æ—Ä–∞
                distanceTooltip = L.tooltip({
                    permanent: false,
                    direction: 'top',
                    className: 'distance-tooltip'
                })
                    .setLatLng(currentLatLng) // –ü–æ–∑–∏—Ü—ñ—è —Ç—É–ª—Ç—ñ–ø–∞ –±—ñ–ª—è –∫—É—Ä—Å–æ—Ä–∞
                    .setContent(`–†–∞–¥—ñ—É—Å: ${radius.toFixed(2)} –º`)
                    .addTo(map);
            };

            map.on('mousemove', moveListener); // –î–æ–¥–∞—î–º–æ —Å–ª—É—Ö–∞—á–∞ –¥–ª—è –ø–æ–¥—ñ—ó mousemove –ø—ñ—Å–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü–µ–Ω—Ç—Ä—É

            // –ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –º–∞–ª—é–≤–∞–Ω–Ω—è –∫–æ–ª–∞
            map.once('pm:drawend', function () { // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ `once` –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –æ–±—Ä–æ–±–ª—è—Ç–∏ –ø–æ–¥—ñ—é —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑
                map.removeLayer(distanceTooltip);
                map.off('mousemove', moveListener); // –í–∏–º–∏–∫–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç—É–ª—Ç—ñ–ø–∞ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –º–∞–ª—é–≤–∞–Ω–Ω—è
            });
        });
    }
});

var selectedPolygon = null; // –¢—É—Ç –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤–∏–±—Ä–∞–Ω–∏–π –ø–æ–ª—ñ–≥–æ–Ω

// –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –Ω–∞ –ø–æ–ª—ñ–≥–æ–Ω –¥–ª—è –≤–∏–±–æ—Ä—É
map.on('pm:create', function (e) {
    e.layer.on('click', function () {
        if (selectedPolygon) {
            selectedPolygon.setStyle({ color: 'red' }); // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–æ–ª—ñ—Ä
        }
        selectedPolygon = this;
        selectedPolygon.setStyle({ color: 'blue' }); // –í–∏–¥—ñ–ª—è—î–º–æ –≤–∏–±—Ä–∞–Ω–∏–π –ø–æ–ª—ñ–≥–æ–Ω
    });
});

// –§—É–Ω–∫—Ü—ñ—è –µ–∫—Å–ø–æ—Ä—Ç—É –≤–∏–±—Ä–∞–Ω–æ–≥–æ –ø–æ–ª—ñ–≥–æ–Ω—É
function exportSelectedGeoJSON() {
    if (!selectedPolygon) {
        alert("–í–∏–±–µ—Ä—ñ—Ç—å –ø–æ–ª—ñ–≥–æ–Ω, –∫–ª—ñ–∫–Ω—É–≤—à–∏ –Ω–∞ –Ω—å–æ–≥–æ!");
        return;
    }

    // –û—Ç—Ä–∏–º—É—î–º–æ GeoJSON
    var geojsonFeature = selectedPolygon.toGeoJSON();
    var geojsonString = JSON.stringify(geojsonFeature, null, 2);

    // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
    var blob = new Blob([geojsonString], { type: "application/json" });
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "selected_polygon.geojson";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—ñ–≥–æ–Ω—É
var downloadButton = L.control({ position: "bottomright" });

downloadButton.onAdd = function (map) {
    var div = L.DomUtil.create("div", "leaflet-bar leaflet-control leaflet-control-custom");
    div.innerHTML = '<button style="background:#fff;border:1px solid #ccc;padding:5px 5px;cursor:pointer;">‚¨áÔ∏è</button>';
    div.onclick = exportSelectedGeoJSON;
    return div;
};

// –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –Ω–∞ –∫–∞—Ä—Ç—É


downloadButton.addTo(map);

L.Control.geocoder({
    position: "topleft",
    defaultMarkGeocode: false
}).on('markgeocode', function(e) {
    map.setView(e.geocode.center, 15);
}).addTo(map);




//-----------------------------–±—É–¥—É–≤–∞–Ω–Ω—è —à–∞—Ä—ñ–≤--------------------------------------    


//-----------------------------–µ–ª–µ–∫—Ç—Ä–æ–º–µ—Ä–µ–∂—ñ--------------------------------------    
    
//-----------------------------–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –Ω–µ–∫--------------------------------------
        



        function addLayersAfterAnimation() {
            setTimeout(() => {
            }, 1000); // –∑–∞—Ç—Ä–∏–º–∫–∞ 4 —Å–µ–∫—É–Ω–¥–∏ (—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –∞–Ω—ñ–º–∞—Ü—ñ—ó)
        }
                        
        addLayersAfterAnimation();


//})
//.catch(error => console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è GeoJSON (–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è):', error));

                                 
    </script>
</body>
</html>
